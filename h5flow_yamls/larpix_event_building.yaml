# Generates the low-level event built data for charge data (i.e. grouped packets, hits, and external triggers)

flow:
  source: raw_event_generator
  stages: [timestamp_corrector, ext_trig_finder, hit_builder, event_builder]

raw_event_generator: # groups time-sorted data packets from larpix datalog files
  classname: RawEventGenerator
  dset_name: 'charge/raw_events'
  params:
    packets_dset_name: 'charge/packets'
    buffer_size: 38400
    nhit_cut: 100
    sync_noise_cut: 100000
    sync_noise_cut_enabled: True
    event_builder_class: 'SymmetricWindowRawEventBuilder'
    event_builder_config:
      window: 910
      threshold: 10

timestamp_corrector: # corrects for different pacman frequencies
  classname: TimestampCorrector
  requires:
    - 'charge/packets'
  params:
    ts_dset_name: 'charge/packets_corr_ts' # new dataset
    packets_dset_name: 'charge/packets' # required datset
    clock_period: 100e-9
    correction:
      1: 3.56e-6
      2: 0.93e-6

ext_trig_finder: # converts pacman trigger packets to ext_trigs
  classname: ExternalTriggerFinder
  requires:
    - 'charge/packets'
    - 'charge/packets_corr_ts'
  params:
    ext_trigs_dset_name: 'charge/ext_trigs' # new dataset
    packets_dset_name: 'charge/packets' # required dataset
    ts_dset_name: 'charge/packets_corr_ts' # required dataset
    pacman_trigger_enabled: True
    pacman_trigger_word_filter: 2
    larpix_trigger_channels: { All: [6] }

hit_builder: # converts larpix data packets and raw events to hits
  classname: HitBuilder
  requires:
    - 'charge/packets'
    - 'charge/packets_corr_ts'
  params:
    hits_dset_name: 'charge/hits'
    packets_dset_name: 'charge/packets'
    ts_dset_name: 'charge/packets_corr_ts'
    geometry_file: ''
    pedestal_file: ''
    configuration_file: ''

event_builder: # combines hits and external triggers into events
  classname: EventBuilder
  requires:
    - 'charge/hits'
    - 'charge/ext_trigs'
  params:
    events_dset_name: 'charge/events'
    hits_dset_name: 'charge/hits'
    ext_trigs_dset_name: 'charge/ext_trigs'


