# Performs combined reconstruction, generating t0s, tracklets, ...

flow:
  #source: 'charge/events'
  source: events
  stages: [t0_reco, tracklet_reco]
  drop: []

events:
  classname: H5FlowDatasetLoopGenerator
  dset_name: 'charge/events'
  params:
    chunk_size: 32

resources:
  - !include h5flow_yamls/resources/units.yaml
  - !include h5flow_yamls/resources/run_data.yaml
  - !include h5flow_yamls/resources/geometry.yaml
  - !include h5flow_yamls/resources/lar_data.yaml

t0_reco:
  classname: T0Reconstruction # combined/t0_reco.py
  requires:
    - 'charge/ext_trigs'
    - name: 'light/hits'
      path: ['light/events', 'light/hits']
  params:
    t0_dset_name: 'combined/t0'
    light_hits_dset_name: 'light/hits'
    ext_trigs_dset_name: 'charge/ext_trigs'

tracklet_reco:
  classname: TrackletReconstruction # combined/tracklet_reco.py
  requires:
    - 'combined/t0'
    - 'charge/hits'
    - name: 'charge/hits_index'
      path: 'charge/hits'
      index_only: True
  params:
    tracklet_dset_name: 'combined/tracklets'
    hits_dset_name: 'charge/hits'
    t0_dset_name: 'combined/t0'
    dbscan_eps: 25
    dbscan_min_samples: 5
    ransac_min_samples: 2
    ransac_residual_threshold: 8
    ransac_max_trials: 10
